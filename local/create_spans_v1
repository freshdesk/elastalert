CREATE TABLE sherlock.span
(
    `timestamp` DateTime64(3) CODEC(Delta(8), LZ4),
    `_source` String CODEC(ZSTD(3)),
    `traceID` String,
    `serviceName` LowCardinality(String),
    `__root_span` UInt8,
    `references` String,
    `hostName` String,
    `startTimeMillis` UInt64 CODEC(DoubleDelta),
    `startTime` UInt64 CODEC(DoubleDelta),
    `duration` UInt64 CODEC(T64),
    `operationName` LowCardinality(String),
    `parentSpanID` String,
    `spanID` String,
    `tags.key` Array(LowCardinality(String)) CODEC(ZSTD(3)),
    `tags.value` Array(String) CODEC(ZSTD(3)),
    `exception_type` String,
    `fw_err_nm_name` String,
    `fw_err_transaction_name` String,
    `application_version` String,
    `exception_message` String,
    `db_type` String,
    `db_statement` String,
    `db_instance` String,
    `transactionName` String MATERIALIZED tags.value[indexOf(tags.key, 'transactionName')],
    `http_method` String MATERIALIZED tags.value[indexOf(tags.key, 'http@method')],
    `http_status_code` String MATERIALIZED tags.value[indexOf(tags.key, 'http@status_code')],
    `http_user_agent` String MATERIALIZED tags.value[indexOf(tags.key, 'http@user_agent')],
    `net_peer_name` String MATERIALIZED tags.value[indexOf(tags.key, 'net@peer@name')],
    `net_peer_port` String MATERIALIZED tags.value[indexOf(tags.key, 'net@peer@port')],
    `net_peer_ip` String MATERIALIZED tags.value[indexOf(tags.key, 'net@peer@ip')],
    `http_url` String MATERIALIZED tags.value[indexOf(tags.key, 'http@url')],
    `net_host_name` String MATERIALIZED tags.value[indexOf(tags.key, 'net@host@name')],
    `net_host_port` String MATERIALIZED tags.value[indexOf(tags.key, 'net@host@port')],
    `net_host_ip` String MATERIALIZED tags.value[indexOf(tags.key, 'net@host@ip')],
    `http_target` String MATERIALIZED tags.value[indexOf(tags.key, 'http@target')],
    `http_route` String MATERIALIZED tags.value[indexOf(tags.key, 'http@route')],
    `http_client_ip` String MATERIALIZED tags.value[indexOf(tags.key, 'http@client_ip')],
    `http_host` String MATERIALIZED tags.value[indexOf(tags.key, 'http@host')],
    `db_system` String MATERIALIZED tags.value[indexOf(tags.key, 'db@system')],
    `db_user` String MATERIALIZED tags.value[indexOf(tags.key, 'db@user')],
    `db_operation` String MATERIALIZED tags.value[indexOf(tags.key, 'db@operation')],
    `messaging_system` String MATERIALIZED tags.value[indexOf(tags.key, 'messaging@system')],
    `messaging_destination` String MATERIALIZED tags.value[indexOf(tags.key, 'messaging@destination')],
    `messaging_destination_kind` String MATERIALIZED tags.value[indexOf(tags.key, 'messaging@destination_kind')],
    `messaging_operation` String MATERIALIZED tags.value[indexOf(tags.key, 'messaging@operation')],
    `messaging_url` String MATERIALIZED tags.value[indexOf(tags.key, 'messaging@url')],
    `k8s_namespace_name` String MATERIALIZED tags.value[indexOf(tags.key, 'k8s@namespace@name')],
    `k8s_pod_ip` String MATERIALIZED tags.value[indexOf(tags.key, 'k8s@pod@ip')],
    `k8s_pod_name` String MATERIALIZED tags.value[indexOf(tags.key, 'k8s@pod@name')],
    `k8s_pod_namespace` String MATERIALIZED tags.value[indexOf(tags.key, 'k8s@pod@namespace')],
    `otel_library_name` String MATERIALIZED tags.value[indexOf(tags.key, 'otel@library@name')],
    `otel_library_version` String MATERIALIZED tags.value[indexOf(tags.key, 'otel@library@version')],
    `telemetry_sdk_name` String MATERIALIZED tags.value[indexOf(tags.key, 'telemetry@sdk@name')],
    `telemetry_sdk_language` String MATERIALIZED tags.value[indexOf(tags.key, 'telemetry@sdk@language')],
    `telemetry_auto_version` String MATERIALIZED tags.value[indexOf(tags.key, 'telemetry@auto@version')],
    `span_kind` String MATERIALIZED tags.value[indexOf(tags.key, 'span@kind')],
    `error` String MATERIALIZED tags.value[indexOf(tags.key, 'error')],
    `rpc_service` String MATERIALIZED tags.value[indexOf(tags.key, 'rpc@service')],
    `rpc_method` String MATERIALIZED tags.value[indexOf(tags.key, 'rpc@method')],
    `rpc_system` String MATERIALIZED tags.value[indexOf(tags.key, 'rpc@system')],
    `rpc_grpc_status_code` String MATERIALIZED tags.value[indexOf(tags.key, 'rpc@grpc@status_code')],
    `fw_a_id` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@a_id')],
    `fw_err_msg_id` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@msg@id')],
    `fw_err_r_id` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@r_id')],
    `fw_p` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@p')],
    `fw_err_req_h_accept` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@h@accept')],
    `fw_err_req_h_host` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@h@host')],
    `fw_err_req_h_ref` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@h@ref')],
    `fw_err_req_h_u_a` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@h@u_a')],
    `fw_err_req_method` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@method')],
    `fw_err_req_resp_code` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@resp_code')],
    `fw_err_req_url` String MATERIALIZED tags.value[indexOf(tags.key, 'fw@err@req@url')]
)
ENGINE = MergeTree
ORDER BY (serviceName, traceID)
SETTINGS index_granularity = 2048 